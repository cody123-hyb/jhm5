<!DOCTYPE html>
<html lang="zh-Hant">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ToDo App (Cloudflare KV)</title>
	<style>
		body { font-family: sans-serif; background: #f7f7f7; margin: 0; padding: 2em; }
		.todo-app { max-width: 400px; margin: auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #ccc; padding: 2em; }
		h2 { text-align: center; }
		ul { list-style: none; padding: 0; }
		li { display: flex; align-items: center; justify-content: space-between; padding: 0.5em 0; border-bottom: 1px solid #eee; }
		li:last-child { border-bottom: none; }
		button { background: #ff5252; color: #fff; border: none; border-radius: 4px; padding: 0.3em 0.7em; cursor: pointer; }
		button:hover { background: #ff1744; }
		input[type="text"] { width: 70%; padding: 0.5em; border: 1px solid #ccc; border-radius: 4px; }
		.add-btn { background: #2196f3; margin-left: 1em; }
		.add-btn:hover { background: #1976d2; }
	</style>
</head>
<body>
	<div class="todo-app">
		<h2>待辦事項 (Cloudflare KV)</h2>
		<form id="todo-form">
			<input type="text" id="todo-input" placeholder="輸入待辦事項..." required />
			<button type="submit" class="add-btn">新增</button>
		</form>
		<ul id="todo-list"></ul>
		<div id="empty-state" style="text-align:center;color:#aaa;margin-top:1em;display:none;">暫無任務，添加一個吧</div>
	</div>
	<script>
		const API_URL = '/api/todos';

		async function fetchTodos() {
			const res = await fetch(API_URL);
			if (!res.ok) return [];
			return await res.json();
		}

		async function addTodo(text) {
			const res = await fetch(API_URL, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ text })
			});
			return res.ok;
		}

		async function updateTodo(id, data) {
			const res = await fetch(`${API_URL}/${id}`, {
				method: 'PUT',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(data)
			});
			return res.ok;
		}

		async function deleteTodo(id) {
			const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
			return res.ok;
		}

		function renderTodos(todos) {
			const list = document.getElementById('todo-list');
			const empty = document.getElementById('empty-state');
			list.innerHTML = '';
			if (!todos.length) {
				empty.style.display = '';
				return;
			} else {
				empty.style.display = 'none';
			}
			todos.forEach(todo => {
				const li = document.createElement('li');
				// 完成狀態
				const checkbox = document.createElement('input');
				checkbox.type = 'checkbox';
				checkbox.checked = !!todo.completed;
				checkbox.style.marginRight = '1em';
				checkbox.onchange = async function() {
					await updateTodo(todo.id, { ...todo, completed: checkbox.checked });
					loadTodos();
				};
				// 任務文字
				const span = document.createElement('span');
				span.textContent = todo.text;
				span.style.flex = '1';
				if (todo.completed) span.style.textDecoration = 'line-through';
				// 編輯
				const editBtn = document.createElement('button');
				editBtn.textContent = '編輯';
				editBtn.style.background = '#ffd600';
				editBtn.style.color = '#333';
				editBtn.style.marginRight = '0.5em';
				editBtn.onclick = function() {
					editTodo(li, todo);
				};
				// 刪除
				const delBtn = document.createElement('button');
				delBtn.textContent = '刪除';
				delBtn.onclick = async function() {
					await deleteTodo(todo.id);
					loadTodos();
				};
				li.appendChild(checkbox);
				li.appendChild(span);
				li.appendChild(editBtn);
				li.appendChild(delBtn);
				list.appendChild(li);
			});
		}

		function editTodo(li, todo) {
			li.innerHTML = '';
			const input = document.createElement('input');
			input.type = 'text';
			input.value = todo.text;
			input.style.flex = '1';
			const saveBtn = document.createElement('button');
			saveBtn.textContent = '儲存';
			saveBtn.style.background = '#2196f3';
			saveBtn.onclick = async function() {
				await updateTodo(todo.id, { ...todo, text: input.value });
				loadTodos();
			};
			const cancelBtn = document.createElement('button');
			cancelBtn.textContent = '取消';
			cancelBtn.onclick = function() { loadTodos(); };
			li.appendChild(input);
			li.appendChild(saveBtn);
			li.appendChild(cancelBtn);
		}

		async function loadTodos() {
			const todos = await fetchTodos();
			renderTodos(todos);
		}

		document.getElementById('todo-form').addEventListener('submit', async (e) => {
			e.preventDefault();
			const input = document.getElementById('todo-input');
			const text = input.value.trim();
			if (text) {
				await addTodo(text);
				input.value = '';
				loadTodos();
			}
		});

		loadTodos();
	</script>
</body>
</html>
